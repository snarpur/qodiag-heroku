Backbone.Validation=(function(_){var defaultOptions={forceUpdate:false,selector:"name",labelFormatter:"sentenceCase",valid:Function.prototype,invalid:Function.prototype};var formatFunctions={formatLabel:function(attrName,model){return defaultLabelFormatters[defaultOptions.labelFormatter](attrName,model)},format:function(){var args=Array.prototype.slice.call(arguments),text=args.shift();return text.replace(/\{(\d+)\}/g,function(match,number){return typeof args[number]!=="undefined"?args[number]:match})}};var flatten=function(obj,into,prefix){into=into||{};prefix=prefix||"";_.each(obj,function(val,key){if(obj.hasOwnProperty(key)){if(val&&typeof val==="object"&&!(val instanceof Date||val instanceof RegExp||val instanceof Backbone.Model||val instanceof Backbone.Collection)){flatten(val,into,prefix+key+".")}else{into[prefix+key]=val}}});return into};var Validation=(function(){var getValidatedAttrs=function(model){return _.reduce(_.keys(model.validation||{}),function(memo,key){memo[key]=void 0;return memo},{})};var getValidators=function(model,attr){var attrValidationSet=model.validation?model.validation[attr]||{}:{};if(_.isFunction(attrValidationSet)||_.isString(attrValidationSet)){attrValidationSet={fn:attrValidationSet}}if(!_.isArray(attrValidationSet)){attrValidationSet=[attrValidationSet]}return _.reduce(attrValidationSet,function(memo,attrValidation){_.each(_.without(_.keys(attrValidation),"msg"),function(validator){memo.push({fn:defaultValidators[validator],val:attrValidation[validator],msg:attrValidation.msg})});return memo},[])};var validateAttr=function(model,attr,value,computed){return _.reduce(getValidators(model,attr),function(memo,validator){var ctx=_.extend({},formatFunctions,defaultValidators),result=validator.fn.call(ctx,value,attr,validator.val,model,computed);if(result===false||memo===false){return false}if(result&&!memo){return validator.msg||result}return memo},"")};var validateModel=function(model,attrs){var error,invalidAttrs={},isValid=true,computed=_.clone(attrs),flattened=flatten(attrs);_.each(flattened,function(val,attr){error=validateAttr(model,attr,val,computed);if(error){invalidAttrs[attr]=error;isValid=false}});return{invalidAttrs:invalidAttrs,isValid:isValid}};var mixin=function(view,options){return{preValidate:function(attr,value){return validateAttr(this,attr,value,_.extend({},this.attributes))},isValid:function(option){var flattened=flatten(this.attributes);if(_.isString(option)){return !validateAttr(this,option,flattened[option],_.extend({},this.attributes))}if(_.isArray(option)){return _.reduce(option,function(memo,attr){return memo&&!validateAttr(this,attr,flattened[attr],_.extend({},this.attributes))},true,this)}if(option===true){this.validate()}return this.validation?this._isValid:true},validate:function(attrs,setOptions){var model=this,validateAll=!attrs,opt=_.extend({},options,setOptions),validatedAttrs=getValidatedAttrs(model),allAttrs=_.extend({},validatedAttrs,model.attributes,attrs),changedAttrs=flatten(attrs||allAttrs),result=validateModel(model,allAttrs);model._isValid=result.isValid;_.each(validatedAttrs,function(val,attr){var invalid=result.invalidAttrs.hasOwnProperty(attr);if(!invalid){opt.valid(view,attr,opt.selector)}});_.each(validatedAttrs,function(val,attr){var invalid=result.invalidAttrs.hasOwnProperty(attr),changed=changedAttrs.hasOwnProperty(attr);if(invalid&&(changed||validateAll)){opt.invalid(view,attr,result.invalidAttrs[attr],opt.selector)}});_.defer(function(){model.trigger("validated",model._isValid,model,result.invalidAttrs);model.trigger("validated:"+(model._isValid?"valid":"invalid"),model,result.invalidAttrs)});if(!opt.forceUpdate&&_.intersection(_.keys(result.invalidAttrs),_.keys(changedAttrs)).length>0){return result.invalidAttrs}}}};var bindModel=function(view,model,options){_.extend(model,mixin(view,options))};var unbindModel=function(model){delete model.validate;delete model.preValidate;delete model.isValid};var collectionAdd=function(model){bindModel(this.view,model,this.options)};var collectionRemove=function(model){unbindModel(model)};return{version:"0.8.0",configure:function(options){_.extend(defaultOptions,options)},bind:function(view,options){var model=view.model,collection=view.collection;options=_.extend({},defaultOptions,defaultCallbacks,options);if(typeof model==="undefined"&&typeof collection==="undefined"){throw"Before you execute the binding your view must have a model or a collection.\nSee http://thedersen.com/projects/backbone-validation/#using-form-model-validation for more information."}if(model){bindModel(view,model,options)}else{if(collection){collection.each(function(model){bindModel(view,model,options)});collection.bind("add",collectionAdd,{view:view,options:options});collection.bind("remove",collectionRemove)}}},unbind:function(view){var model=view.model,collection=view.collection;if(model){unbindModel(view.model)}if(collection){collection.each(function(model){unbindModel(model)});collection.unbind("add",collectionAdd);collection.unbind("remove",collectionRemove)}},mixin:mixin(null,defaultOptions)}}());var defaultCallbacks=Validation.callbacks={valid:function(view,attr,selector){view.$("["+selector+'~="'+attr+'"]').removeClass("invalid").removeAttr("data-error")},invalid:function(view,attr,error,selector){view.$("["+selector+'~="'+attr+'"]').addClass("invalid").attr("data-error",error)}};var defaultPatterns=Validation.patterns={digits:/^\d+$/,number:/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/,email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,url:/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i};var defaultMessages=Validation.messages={required:"{0} is required",acceptance:"{0} must be accepted",min:"{0} must be greater than or equal to {1}",max:"{0} must be less than or equal to {1}",range:"{0} must be between {1} and {2}",length:"{0} must be {1} characters",minLength:"{0} must be at least {1} characters",maxLength:"{0} must be at most {1} characters",rangeLength:"{0} must be between {1} and {2} characters",oneOf:"{0} must be one of: {1}",equalTo:"{0} must be the same as {1}",pattern:"{0} must be a valid {1}"};var defaultLabelFormatters=Validation.labelFormatters={none:function(attrName){return attrName},sentenceCase:function(attrName){return attrName.replace(/(?:^\w|[A-Z]|\b\w)/g,function(match,index){return index===0?match.toUpperCase():" "+match.toLowerCase()}).replace("_"," ")},label:function(attrName,model){return(model.labels&&model.labels[attrName])||defaultLabelFormatters.sentenceCase(attrName,model)}};var defaultValidators=Validation.validators=(function(){var trim=String.prototype.trim?function(text){return text===null?"":String.prototype.trim.call(text)}:function(text){var trimLeft=/^\s+/,trimRight=/\s+$/;return text===null?"":text.toString().replace(trimLeft,"").replace(trimRight,"")};var isNumber=function(value){return _.isNumber(value)||(_.isString(value)&&value.match(defaultPatterns.number))};var hasValue=function(value){return !(_.isNull(value)||_.isUndefined(value)||(_.isString(value)&&trim(value)===""))};return{fn:function(value,attr,fn,model,computed){if(_.isString(fn)){fn=model[fn]}return fn.call(model,value,attr,computed)},required:function(value,attr,required,model,computed){var isRequired=_.isFunction(required)?required.call(model,value,attr,computed):required;if(!isRequired&&!hasValue(value)){return false}if(isRequired&&!hasValue(value)){return this.format(defaultMessages.required,this.formatLabel(attr,model))}},acceptance:function(value,attr,accept,model){if(value!=="true"&&(!_.isBoolean(value)||value===false)){return this.format(defaultMessages.acceptance,this.formatLabel(attr,model))}},min:function(value,attr,minValue,model){if(!isNumber(value)||value<minValue){return this.format(defaultMessages.min,this.formatLabel(attr,model),minValue)}},max:function(value,attr,maxValue,model){if(!isNumber(value)||value>maxValue){return this.format(defaultMessages.max,this.formatLabel(attr,model),maxValue)}},range:function(value,attr,range,model){if(!isNumber(value)||value<range[0]||value>range[1]){return this.format(defaultMessages.range,this.formatLabel(attr,model),range[0],range[1])}},length:function(value,attr,length,model){if(!hasValue(value)||trim(value).length!==length){return this.format(defaultMessages.length,this.formatLabel(attr,model),length)}},minLength:function(value,attr,minLength,model){if(!hasValue(value)||trim(value).length<minLength){return this.format(defaultMessages.minLength,this.formatLabel(attr,model),minLength)}},maxLength:function(value,attr,maxLength,model){if(!hasValue(value)||trim(value).length>maxLength){return this.format(defaultMessages.maxLength,this.formatLabel(attr,model),maxLength)}},rangeLength:function(value,attr,range,model){if(!hasValue(value)||trim(value).length<range[0]||trim(value).length>range[1]){return this.format(defaultMessages.rangeLength,this.formatLabel(attr,model),range[0],range[1])}},oneOf:function(value,attr,values,model){if(!_.include(values,value)){return this.format(defaultMessages.oneOf,this.formatLabel(attr,model),values.join(", "))}},equalTo:function(value,attr,equalTo,model,computed){if(value!==computed[equalTo]){return this.format(defaultMessages.equalTo,this.formatLabel(attr,model),this.formatLabel(equalTo,model))}},pattern:function(value,attr,pattern,model){if(!hasValue(value)||!value.toString().match(defaultPatterns[pattern]||pattern)){return this.format(defaultMessages.pattern,this.formatLabel(attr,model),pattern)}}}}());return Validation}(_));