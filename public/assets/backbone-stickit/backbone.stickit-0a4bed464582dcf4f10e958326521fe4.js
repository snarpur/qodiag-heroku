(function(h){Backbone.Stickit={_handlers:[],addHandler:function(a){a=_.map(_.flatten([a]),function(a){return _.extend({updateModel:!0,updateView:!0,updateMethod:"text"},a)});this._handlers=this._handlers.concat(a)}};_.extend(Backbone.View.prototype,{_modelBindings:null,unstickit:function(a){_.each(this._modelBindings,_.bind(function(b,c){if(a&&b.model!==a)return!1;b.model.off(b.event,b.fn);b.model.trigger("stickit:unstuck");delete this._modelBindings[c]},this));this._modelBindings=_.compact(this._modelBindings);
this.$el.off(".stickit"+(a?"."+a.cid:""))},stickit:function(a,b){var c=this,d=a||this.model,g=".stickit."+d.cid,e=b||this.bindings||{};this._modelBindings||(this._modelBindings=[]);this.unstickit(d);_.each(_.keys(e),function(a){var b,l,k,f,n=e[a]||{},h=_.uniqueId();":el"!=a?b=c.$(a):(b=c.$el,a="");b.length&&(_.isString(n)&&(n={observe:n}),_.isFunction(n.observe)&&(n.observe=n.observe.call(c)),f=w(b,n),k=f.observe,f.bindId=h,l=_.extend({stickitChange:f},f.setOptions||{}),x(c,b,f,d,k),y(c,b,f,d,k),
k&&(_.each(f.events||[],function(e){e+=g;var n=function(a){a=f.getVal.call(c,b,a,f);t(c,f.updateModel,a,f)&&(f.onSet&&(a=p(c,f.onSet,a,f)),d.set(k,a,l))};if(""===a)c.$el.on(e,n);else c.$el.on(e,a,n)}),_.each(_.flatten([k]),function(a){s(d,c,"change:"+a,function(a,d,e){(e&&e.stickitChange&&e.stickitChange.bindId||null)!=h&&u(c,b,f,q(a,k,f,c),a)})}),u(c,b,f,q(d,k,f,c),d,!0)),p(c,f.initialize,b,d,f))});this.remove=_.wrap(this.remove,function(a){c.unstickit();a&&a.call(c);return c})}});var r=function(a,
b){var c=(b||"").split("."),c=_.reduce(c,function(a,b){return a[b]},a);return null==c?a:c},p=function(a,b){if(b)return(_.isString(b)?a[b]:b).apply(a,_.toArray(arguments).slice(2))},v=function(a){return a.find("option").not(function(){return!this.selected})},t=function(a,b){return _.isBoolean(b)?b:_.isFunction(b)||_.isString(b)?p.apply(this,_.toArray(arguments)):!1},s=function(a,b,c,d){a.on(c,d,b);b._modelBindings.push({model:a,event:c,fn:d})},q=function(a,b,c,d){var g=function(b){b=c.escape?a.escape(b):
a.get(b);return _.isUndefined(b)||_.isNull(b)?"":b};b=_.isArray(b)?_.map(b,g):g(b);return c.onGet?p(d,c.onGet,b,c):b},w=Backbone.Stickit.getConfiguration=function(a,b){var c=[{updateModel:!1,updateMethod:"text",update:function(a,b,c,d){if(a[d.updateMethod])a[d.updateMethod](b)},getVal:function(a,b,c){return a[c.updateMethod]()}}];_.each(Backbone.Stickit._handlers,function(b){a.is(b.selector)&&c.push(b)});c.push(b);var d=_.extend.apply(_,c);d.visible&&!_.has(d,"updateView")?d.updateView=!1:_.has(d,
"updateView")||(d.updateView=!0);delete d.selector;return d},x=function(a,b,c,d,g){var e="autofocus autoplay async checked controls defer disabled hidden loop multiple open readonly required scoped selected".split(" ");_.each(c.attributes||[],function(c){var h="",l,k;c=_.clone(c);l=c.observe||(c.observe=g);k=function(){var f=-1<_.indexOf(e,c.name,!0)?"prop":"attr",g=q(d,l,c,a);if("class"==c.name)b.removeClass(h).addClass(g),h=g;else b[f](c.name,g)};_.each(_.flatten([l]),function(b){s(d,a,"change:"+
b,k)});k()})},y=function(a,b,c,d,g){if(null!=c.visible){var e=function(){var e=c.visible,h=c.visibleFn,l=q(d,g,c,a),k=!!l;if(_.isFunction(e)||_.isString(e))k=p(a,e,l,c);h?p(a,h,b,k,c):k?b.show():b.hide()};_.each(_.flatten([g]),function(b){s(d,a,"change:"+b,e)});e()}},u=function(a,b,c,d,g,e){t(a,c.updateView,d,c)&&(c.update.call(a,b,d,g,c),e||p(a,c.afterUpdate,b,d,c))};Backbone.Stickit.addHandler([{selector:'[contenteditable="true"]',updateMethod:"html",events:["input","change"]},{selector:"input",
events:["propertychange","input","change"],update:function(a,b){a.val(b)},getVal:function(a){var b=a.val();return a.is('[type="number"]')?null==b?b:Number(b):b}},{selector:"textarea",events:["propertychange","input","change"],update:function(a,b){a.val(b)},getVal:function(a){return a.val()}},{selector:'input[type="radio"]',events:["change"],update:function(a,b){a.filter('[value="'+b+'"]').prop("checked",!0)},getVal:function(a){return a.filter(":checked").val()}},{selector:'input[type="checkbox"]',
events:["change"],update:function(a,b,c,d){1<a.length?(b||(b=[]),_.each(a,function(a){-1<_.indexOf(b,h(a).val())?h(a).prop("checked",!0):h(a).prop("checked",!1)})):_.isBoolean(b)?a.prop("checked",b):a.prop("checked",b==a.val())},getVal:function(a){var b;if(1<a.length)b=_.reduce(a,function(a,b){h(b).prop("checked")&&a.push(h(b).val());return a},[]);else{b=a.prop("checked");var c=a.val();"on"!=c&&null!=c&&(b=b?a.val():null)}return b}},{selector:"select",events:["change"],update:function(a,b,c,d){var g,
e=d.selectOptions,m=e&&e.collection||void 0,q=a.prop("multiple");if(!e){var e={},l=function(a){return a.map(function(){return{value:this.value,label:this.text}}).get()};a.find("optgroup").length?(m={opt_labels:[]},a.find("> option").length&&(m.opt_labels.push(void 0),_.each(a.find("> option"),function(a){m[void 0]=l(h(a))})),_.each(a.find("optgroup"),function(a){var b=h(a).attr("label");m.opt_labels.push(b);m[b]=l(h(a).find("option"))})):m=l(a.find("option"))}e.valuePath=e.valuePath||"value";e.labelPath=
e.labelPath||"label";var k=function(a,b,c){e.defaultOption&&(a=_.clone(a),a.unshift("__default__"));_.each(a,function(a){var d=h("<option/>"),f=a,g=function(a,b){d.text(a);f=b;d.data("stickit_bind_val",f);!_.isArray(f)&&!_.isObject(f)&&d.val(f)};"__default__"===a?g(e.defaultOption.label,e.defaultOption.value):g(r(a,e.labelPath),r(a,e.valuePath));!q&&null!=f&&null!=c&&f==c||_.isObject(c)&&_.isEqual(f,c)?d.prop("selected",!0):q&&_.isArray(c)&&_.each(c,function(a){_.isObject(a)&&(a=r(a,e.valuePath));
(a==f||_.isObject(a)&&_.isEqual(f,a))&&d.prop("selected",!0)});b.append(d)})};a.html("");c=function(a,b){var c=window;0===b.indexOf("this.")&&(c=a);b=b.replace(/^[a-z]*\.(.+)$/,"$1");return r(c,b)};g=_.isString(m)?c(this,m):_.isFunction(m)?p(this,m,a,d):m;g instanceof Backbone.Collection&&(g=g.toJSON());_.isArray(g)?k(g,a,b):_.each(g.opt_labels,function(c){var d=h("<optgroup/>").attr("label",c);k(g[c],d,b);a.append(d)})},getVal:function(a){return a.prop("multiple")?h(v(a).map(function(){return h(this).data("stickit_bind_val")})).get():
v(a).data("stickit_bind_val")}}])})(window.jQuery||window.Zepto);
