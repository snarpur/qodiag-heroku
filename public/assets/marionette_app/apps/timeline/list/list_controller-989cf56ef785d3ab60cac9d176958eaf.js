(function(){var l=function(e,d){return function(){return e.apply(d,arguments)}},h={}.hasOwnProperty,m=function(e,d){function g(){this.constructor=e}for(var f in d)h.call(d,f)&&(e[f]=d[f]);g.prototype=d.prototype;e.prototype=new g;e.__super__=d.prototype;return e};this.Qapp.module("TimelineApp.List",function(e,d,g,f,h,k){return e.Controller=function(f){function b(){this.showMenu=l(this.showMenu,this);return b.__super__.constructor.apply(this,arguments)}m(b,f);b.prototype.initialize=function(a,c){this.subjectId=
a;this.showSubjectNavigation(a);return this.getItems()};b.prototype.getItems=function(){this.items=d.request("get:person:responder:items",{personId:this.subjectId,concern:"subject"});this.visItems=new vis.DataSet;this.initialSurveys=[];return d.execute("when:fetched",this.items,function(a){return function(){a.items.each(function(c){if(null!=c.get("survey_id"))return a.visItems.add(a.buildItem(c)),a.initialSurveys.push(c.get("survey_id"))});a.showContent({items:a.items,visItems:a.visItems});return a.listenTo(a.items,
"add",function(a,b){return this.visItems.add(this.buildItem(a))})}}(this))};b.prototype.buildItem=function(a){var c,b;b=new Date(null!=(c=a.get("completed"))?c:a.get("deadline"));b=moment(b).minutes(0).seconds(0).milliseconds(0);c={id:""+a.get("id"),surveyId:a.get("survey_id"),type:"point",className:this.getItemClassName(a)};c.start=b;c.content=null!=a.get("survey")?a.get("survey").access_code:this.surveys.get(a.get("survey_id")).get("access_code");return c};b.prototype.getItemClassName=function(a){if(this.isCompleted(a))return"completed";
if(this.isPending(a))return"pending";if(this.isOverdue(a))return"overdue"};b.prototype.deadlineIsPassed=function(a){return Date.parse(a.get("deadline")).isBefore(Date.today())};b.prototype.isCompleted=function(a){return null!=a.get("completed")};b.prototype.isOverdue=function(a){return!this.isPending(a)&&!this.isCompleted(a)};b.prototype.isPending=function(a){return!this.isCompleted(a)&&!this.deadlineIsPassed(a)};b.prototype.showSubjectNavigation=function(a){this.person=d.request("get:person:entity",
a);return d.execute("when:fetched",this.person,function(c){return function(){return d.execute("show:subject:navigation",{person:c.person,personId:a,currentItemName:"timeline"})}}(this))};b.prototype.showContent=function(a){this.listenTo(this.getLayout(),"show",function(c){return function(){c.showTimeline(a);return c.showMenu()}}(this));this.listenTo(this.getLayout(),"add:survey:clicked",function(a){return function(){return a.createSurvey({itemCollection:a.items})}}(this));return d.contentRegion.show(this.getLayout())};
b.prototype.showMenu=function(){this.surveys=d.request("get:surveys");return d.execute("when:fetched",this.surveys,function(a){return function(){null==a.menuView&&(a.menuView=new e.Select({model:new g.Model,items:a.items,collection:a.surveys,initialSurveys:k.uniq(a.initialSurveys)}));a.show(a.menuView,{region:a.getLayout().menuRegion});return a.listenTo(a.menuView,"select:menu:changed",function(c){return null!=c.removed?a.hideSurvey(c.removed.id):a.showSurvey(c.added.id)})}}(this))};b.prototype.showSurvey=
function(a){return this.items.each(function(c){return function(b){if(b.get("survey_id")===a)return c.visItems.add(c.buildItem(b))}}(this))};b.prototype.hideSurvey=function(a){var c;c=this.visItems.get({fields:["id"],filter:function(c){return function(c){return c.surveyId===a}}(this)});return this.visItems.remove(k.pluck(c,"id"))};b.prototype.getTimeline=function(a){return null!=this.timelineView?this.timelineView:this.timelineView=new e.Timeline({model:a})};b.prototype.getLayout=function(){return null!=
this.layout?this.layout:this.layout=new e.Layout};b.prototype.showTimeline=function(a){a=new g.Model(a);this.show(this.getTimeline(a),{region:this.getLayout().timelineRegion});return this.listenTo(this.getTimeline(),"item:selected",function(a){return function(b){if(null!=b.item.get("completed"))return a.getColumnCharts(b)}}(this))};b.prototype.createSurvey=function(a){null==a&&(a={});return d.request("create:survey:view",a)};b.prototype.chartsLayout=function(a){null==a&&(a={});return new d.Components.Charts.ChartLayout(a)};
b.prototype.chartsView=function(a){return new d.Components.Charts.ColumnCharts(a)};b.prototype.onChangeChart=function(a){return this.listenTo(a,"active:chart:selected",function(a){return function(b){a.charts.setCurrentMetric(b.model.get("name"));return a.updateChart()}}(this))};b.prototype.onChangeFilter=function(a){return this.listenTo(a,"filter:changed",function(a){return function(b,d){a.charts.setNormReferenceId(d.id);return a.updateChart()}}(this))};b.prototype.updateChart=function(){return this.charts.fetch({reset:!0})};
b.prototype.getColumnCharts=function(a){var b;b=this.chartsLayout();d.dialogRegion.show(b);this.charts=d.request("column:charts",a);return d.execute("when:fetched",this.charts,function(a){return function(){var d;d=a.chartsView({collection:a.charts});a.onChangeChart(b);a.onChangeFilter(b);return b.chartsRegion.show(d)}}(this))};return b}(d.Controllers.Base)})}).call(this);
