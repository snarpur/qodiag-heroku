(function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child};this.Qapp.module("SubjectEntriesApp.List",function(List,App,Backbone,Marionette,$,_){var _ref;return List.Controller=(function(_super){__extends(Controller,_super);function Controller(){_ref=Controller.__super__.constructor.apply(this,arguments);return _ref}Controller.prototype.initialize=function(options){var _this=this;this.person=App.request("get:person:entity",options.personId);App.execute("when:fetched",this.person,function(){return App.execute("show:subject:navigation",{person:_this.person,personId:options.personId,currentItemName:"entries"})});return this.list(options)};Controller.prototype.list=function(options){var entrySetResponseId,sectionId,_this=this;this.personId=options.personId,entrySetResponseId=options.entrySetResponseId,sectionId=options.sectionId;this.showLayout(this.items);this.items=App.request("get:person:entry:set:responder:items",options);return App.execute("when:fetched",this.items,function(){var currentItem;_this.showEntrySetSelect(_this.items);if(_this.items.size()!==0){currentItem=entrySetResponseId?_this.items.where({entry_set_response_id:entrySetResponseId})[0]:_this.items.first();_this.getSections(currentItem,sectionId)}else{}return _this.listenTo(_this.getLayout(),"add:item:clicked",function(){return _this.createItemSetup({collection:_this.items})})})};Controller.prototype.getSections=function(currentItem,sectionId){var options,sections,_this=this;options={entrySetId:currentItem.get("entry_set_response").get("entry_set_id"),entrySetResponse:currentItem.get("entry_set_response"),currentSectionId:sectionId};sections=App.request("entry:set:sections:entities",options);return App.execute("when:fetched",sections,function(){_this.showSections(sections,sections.getCurrentSection().id);return _this.getEntries(sections.getCurrentSection())})};Controller.prototype.getEntries=function(section){var entries;entries=section.getSectionEntryResponses();return this.showEntryFields(entries)};Controller.prototype.showEntrySetSelect=function(items){var selectView,_this=this;selectView=new List.SelectItems({collection:items,layout:this.getLayout()});this.show(selectView,{region:this.getEntrySetSelectRegion(),loading:false});return this.listenTo(selectView,"select:response",function(view){return _this.getSections(view.model)})};Controller.prototype.showSections=function(sections,currentSectionId){var sectionsView,_this=this;sectionsView=new List.Sections({collection:sections});this.listenTo(sectionsView,"childview:set:current:section",function(view){_this.getEntries(view.model);return App.navigate(_this.entriesUrl(view.model),{replace:false})});return this.show(sectionsView,{region:this.getSectionRegion(),loading:false})};Controller.prototype.showEntryFields=function(entries){var entriesView,_this=this;entriesView=new List.Entries({collection:entries});this.getEntrySetValuesRegion().on("show",function(){return entriesView.children.each(function(view){var region;region=_this.layout.addRegion(view.entryValueRegionName(),"#"+(view.entryValueRegionName()));return App.execute("show:entry:values",{region:region,entryField:view.model,entries:entries})})});return this.show(entriesView,{loading:{loadingType:"spinner"},region:this.getEntrySetValuesRegion()})};Controller.prototype.createItemSetup=function(options){var view;if(options==null){options={}}return view=App.request("create:responder:item:view",options)};Controller.prototype.getEntrySetValuesRegion=function(){return this.getLayout().entrySetValuesRegion};Controller.prototype.getEntrySetSelectRegion=function(){return this.getLayout().entrySetSelectRegion};Controller.prototype.getSectionRegion=function(){return this.getLayout().entrySetSectionsRegion};Controller.prototype.showLayout=function(items){return App.request("default:region").show(this.getLayout())};Controller.prototype.getLayout=function(){var _ref1;return(_ref1=this.layout)!=null?_ref1:this.layout=new List.Layout};Controller.prototype.entriesUrl=function(entry){return _(""+(Routes.person_path(this.personId))+"/entries/"+(entry.get("entrySetResponseId"))+"/section/"+entry.id).ltrim("/")};return Controller})(App.Controllers.Base)})}).call(this);