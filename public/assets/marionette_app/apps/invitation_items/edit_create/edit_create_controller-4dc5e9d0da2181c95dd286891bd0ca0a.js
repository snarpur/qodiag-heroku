(function(){var l=function(d,c){return function(){return d.apply(c,arguments)}},k={}.hasOwnProperty,m=function(d,c){function g(){this.constructor=d}for(var e in c)k.call(c,e)&&(d[e]=c[e]);g.prototype=c.prototype;d.prototype=new g;d.__super__=c.prototype;return d};this.Qapp.module("InvitationItemsApp.EditCreate",function(d,c,g,e,k,h){return d.Controller=function(e){function b(){this.getFieldsView=l(this.getFieldsView,this);return b.__super__.constructor.apply(this,arguments)}m(b,e);b.prototype.initialize=
function(){c.contentRegion.show(this.getLayout());return this.curentUser=c.request("get:current:user")};b.prototype.create=function(a){null==a&&(a={});this.type=a.type;this.step=a.step;this.id=a.id;this.steps=c.request("set:invitation:steps",a);this.step=1;return this.showFormSteps(this.steps,a)};b.prototype.edit=function(a){var f;null==a&&(a={});this.type=a.type;this.step=a.step;this.id=a.id;this.steps=c.request("set:invitation:steps",a);this.step=this.steps.currentStep;f=c.request("get:responder:item",
{id:this.id,step_no:this.step,type:this.type});return c.execute("when:fetched",f,function(b){return function(){null==f.id&&(b.step=1,b.steps.setCurrentStep(b.step),b.steps.trigger("change:current:step"));b.id=f.get("id");b.rootModel=new c.Entities.FormInvitationItemModel(f.attributes);return b.showFormSteps(b.steps,a)}}(this))};b.prototype.showFormSteps=function(a){a=this.getFormStepsView(this.steps);null!=this.step&&(c.navigate(this.invitationUrl(this.step),{replace:!0}),this.steps.setCurrentStep(this.step));
this.getLayout().formStepsRegion.show(a);return this.showForm()};b.prototype.showForm=function(){var a;null==this.id&&(a=this.getResponse(),this.rootModel=new c.Entities.FormInvitationItemModel(a));a=this.getFormConfig();this.controllerModel=new c.Entities.Model;this.fieldCollection=new c.Entities.FieldCollection(a,{rootModel:this.rootModel,controllerModel:this.controllerModel});2===this.step&&"guardian"===this.type&&this.getChildren();a=this.getFieldsView(this.fieldCollection);this.formView=c.request("form:wrapper",
a,this.buttonsConfig());this.listenTo(this.controllerModel,"change:children",function(a){return function(b,c,d){if(""!==c)return a.rootModel.get("subject").set("full_cpr",c)}}(this));this.listenTo(this.formView,"form:back",function(a){return function(){return a.moveToPreviousStep()}}(this));this.listenTo(this.formView,"form:saveAndContinue form:save",function(a){return function(){return a.formView.trigger("form:submit",{collection:!1})}}(this));this.listenTo(this.formView,"before:form:submit",function(a){return function(){return a.saveFormData()}}(this));
return this.getLayout().mainRegion.show(this.formView)};b.prototype.getChildren=function(){var a,b;return null!=(null!=(b=this.rootModel.get("respondent"))?b.get("full_cpr"):void 0)&&10===this.rootModel.get("respondent").get("full_cpr").length?(a=c.request("get:national_register:family",this.rootModel.get("respondent").get("full_cpr")),c.execute("when:fetched",a,function(b){return function(){if(!a.isEmpty())return b.controllerModel.set("_children_options",a)}}(this))):this.controllerModel.set("_children_options",
[])};b.prototype.invitationUrl=function(a){return null!=this.id?"invitation_items/"+this.id+"/invite/"+this.type+"/step/"+a:"invitation_items/invite/"+this.type+"/step/"+a};b.prototype.saveFormData=function(){return this.listenToOnce(this.rootModel,"created updated",function(a){return function(b){toastr.success(I18n.t("activerecord.sucess.messages.saved",{model:""}));if(a.steps.isCurrentLast())return window.location.href="/users";a.step=a.steps.getNextStep();return a.changeStep()}}(this))};b.prototype.changeStep=
function(){var a;this.steps.setCurrentStep(this.step);this.steps.trigger("change:current:step");a=c.request("get:responder:item",{id:this.rootModel.get("id"),step_no:this.step,type:this.type});return c.execute("when:fetched",a,function(b){return function(){b.id=a.get("id");b.rootModel=new c.Entities.FormInvitationItemModel(a.attributes);c.navigate(b.invitationUrl(b.step),{replace:!0});return b.showForm()}}(this))};b.prototype.moveToPreviousStep=function(){this.step=this.steps.getPreviousStep();return this.changeStep()};
b.prototype.buttonsConfig=function(){var a;a={formClass:"form-horizontal",errors:!1,buttons:{primary:!1,save:!1,cancel:!1}};this.steps.isCurrentLast()?"guardian"===this.type?h.extend(a.buttons,{primary:!1,save:{text:I18n.t("actions.save"),buttonType:"save",order:2,className:"btn btn-success"},back:{text:"<< "+I18n.t("terms.go_back"),buttonType:"back",className:"btn btn-info",order:1}}):h.extend(a.buttons,{primary:!1},{save:{text:I18n.t("actions.save"),buttonType:"save",order:2,className:"btn btn-success"},
back:!1}):"guardian"===this.type&&h.extend(a.buttons,{primary:{text:I18n.t("actions.save_and_continue",{model:""})+" >>",className:"btn btn-info",buttonType:"saveAndContinue",order:3}});return a};b.prototype.getFieldsView=function(a){return new c.Components.Form.FieldCollectionView({collection:a,model:this.rootModel})};b.prototype.getFormConfig=function(){return d.FormConfig[this.type]["step_"+this.step]};b.prototype.getResponse=function(){return"subject"===this.type?{deadline:null,registration_identifier:"subject_registration",
subject:{firstname:null,address:{street_1:null},user:{email:null,invitation:!0},inverse_relationships:[{name:"patient",person_id:this.curentUser.get("person_id")}]}}:{deadline:null,registration_identifier:"respondent_registration",respondent:{firstname:null,address:{street_1:null},user:{email:null,invitation:!0}}}};b.prototype.getFormStepsView=function(a){return new d.FormSteps({collection:this.steps})};b.prototype.getFormStepsRegion=function(){return this.getLayout().formStepsRegion};b.prototype.getLayout=
function(){return null!=this.layout?this.layout:this.layout=new d.Layout};return b}(c.Controllers.Base)})}).call(this);
