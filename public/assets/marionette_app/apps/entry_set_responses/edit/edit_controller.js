(function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child};this.Qapp.module("EntrySetResponsesApp.Edit",function(Edit,App,Backbone,Marionette,$,_){var _ref;return Edit.Controller=(function(_super){__extends(Controller,_super);function Controller(){_ref=Controller.__super__.constructor.apply(this,arguments);return _ref}Controller.prototype.initialize=function(options){return App.contentRegion.show(this.getLayout())};Controller.prototype.edit=function(options){return this.getSections(options)};Controller.prototype.getSections=function(options){var entrySetResponseId,sectionId,_this=this;entrySetResponseId=options.entrySetResponseId,sectionId=options.sectionId;this.entrySetResponse=App.request("entry:set:response:entities",{id:entrySetResponseId});return App.execute("when:fetched",this.entrySetResponse,function(){_this.sections=_this.entrySetResponse.get("entry_sets_sections");if(sectionId){_this.sections.trigger("change:current:section",{model:_this.sections.get(sectionId)})}_this.showFormSteps();_this.listenTo(_this.sections,"change:current:section",function(){App.navigate(_this.sectionUrl(),{replace:true});return _this.getEntries()});return _this.getEntries()})};Controller.prototype.getEntries=function(){var entries,_this=this;entries=this.entrySetResponse.getSectionResponses();return App.execute("when:fetched",entries,function(){_this.entrySetResponse.set("entry_values",entries.mergeEntryValues());return _this.showForm()})};Controller.prototype.showFormSteps=function(){var view;view=this.getFormStepsView({collection:this.sections});return this.show(view,{region:this.getFormStepsRegion(),loading:false})};Controller.prototype.showForm=function(){var editView,formView,_this=this;editView=this.getFormView();formView=App.request("form:wrapper",editView,this.buttonsConfig());this.show(formView,{region:this.getFormWrapperRegion(),loading:true});this.listenTo(formView,"form:back",function(){return _this.sections.trigger("change:current:section",{model:_this.sections.getPreviousSection()})});this.listenTo(formView,"form:save",function(){return _this.triggerSuccessMessage(formView)});this.listenTo(formView,"form:saveAndContinue",function(){return _this.saveAndMoveToNextSection(formView)});return this.listenTo(formView,"form:saveAndComplete",function(){return _this.saveAsCompleteAndRedirect(formView)})};Controller.prototype.saveAndMoveToNextSection=function(formView){var _this=this;formView.trigger("form:submit");return this.listenToOnce(this.entrySetResponse,"updated",function(){return _this.sections.trigger("change:current:section",{model:_this.sections.getNextSection()})})};Controller.prototype.triggerSuccessMessage=function(formView){var _this=this;formView.trigger("form:submit");return this.listenToOnce(this.entrySetResponse,"updated",function(){return toastr.success("Færsla hefur vistast")})};Controller.prototype.saveAsCompleteAndRedirect=function(formView){var _this=this;this.entrySetResponse.set("complete_item",1);formView.trigger("form:submit");return this.listenToOnce(this.entrySetResponse,"updated",function(){App.navigate("/items",{trigger:true});return toastr.success("Færsla hefur vistast")})};Controller.prototype.getFormStepsView=function(options){return new Edit.FormSteps(_.extend(options))};Controller.prototype.getFormView=function(){return new Edit.EntryValues({collection:this.entrySetResponse.get("entry_values"),model:this.entrySetResponse})};Controller.prototype.getFormStepsRegion=function(){return this.getLayout().formStepsRegion};Controller.prototype.getFormWrapperRegion=function(){return this.getLayout().formWrapperRegion};Controller.prototype.buttonsConfig=function(){var options;options={buttons:{primary:{text:"Áfram og vista >>",buttonType:"saveAndContinue",order:3},save:{text:"Vista",buttonType:"save",order:2,className:"btn btn-success"},cancel:false}};if(this.sections.isCurrentLast()){options.buttons.primary=_.extend(options.buttons.primary,{text:"Vista og klára",buttonType:"saveAndComplete"})}if(!this.sections.isCurrentFirst()){_.extend(options.buttons,{back:{text:"<< Tilbaka",buttonType:"back",className:"btn",order:1}})}return options};Controller.prototype.getLayout=function(){var _ref1;return(_ref1=this.layout)!=null?_ref1:this.layout=new Edit.Layout};Controller.prototype.sectionUrl=function(){return Routes.entry_set_response_section_path(this.entrySetResponse.id,this.sections.getCurrentSection().id)};return Controller})(App.Controllers.Base)})}).call(this);