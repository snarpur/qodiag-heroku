(function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child};this.Qapp.module("Entities",function(Entities,App,Backbone,Marionette,$,_){var API,_ref,_ref1;Entities.EntryField=(function(_super){__extends(EntryField,_super);function EntryField(){_ref=EntryField.__super__.constructor.apply(this,arguments);return _ref}EntryField.prototype.urlRoot=Routes.entry_fields_path();EntryField.prototype.paramRoot="entry_field";EntryField.prototype.blacklist=["index","editable","ok"];EntryField.prototype.initialize=function(){this.initializeEntryValues();return this.url=function(){if(this.isNew()){return this.urlRoot}else{return""+this.urlRoot+"/"+this.id}}};EntryField.prototype.initializeEntryValues=function(){var entryValues;if(this.get("entry_values")==null){return}if(!(this.get("entry_values") instanceof Backbone.Collection)){entryValues=_.isArray(this.get("entry_values"))?this.get("entry_values"):[this.get("entry_values")];this.set("entry_values",new Entities.EntryValues(this.get("entry_values"),{entryField:this},{silent:true}))}return this.on("change:entry_values",this.initializeEntryValues)};return EntryField})(Entities.Model);Entities.EntryFields=(function(_super){__extends(EntryFields,_super);function EntryFields(){_ref1=EntryFields.__super__.constructor.apply(this,arguments);return _ref1}EntryFields.prototype.model=Entities.EntryField;EntryFields.prototype.initialize=function(models,options){this.sectionId=options.sectionId,this.entrySetId=options.entrySetId;return this.url=function(){if(this.sectionId){return Routes.section_entry_fields_path(this.sectionId)}else{return Routes.entry_fields_path()}}};EntryFields.prototype.comparator=function(entryField){return _(entryField.get("title")).capitalize()};EntryFields.prototype.mergeEntryValues=function(){return new App.Entities.EntryValues(_.flatten(this.pluck("entry_values").map(function(i){return i.toJSON()})))};EntryFields.prototype.getSearchCollection=function(){return this.searchCollection};EntryFields.prototype.getLiveCollection=function(){return this.liveCollection};EntryFields.prototype.createSearchCollection=function(disabledIds){if(disabledIds==null){disabledIds=[]}if(!_.isEmpty(disabledIds)){this.remove(this.filter(function(model){return _.contains(disabledIds,model.id)}))}this.liveCollection=window.queryEngine.createLiveCollection(this.models);this.liveCollection.setComparator(function(entry){return _(entry.get("title")).capitalize()});this.on("search:update",function(searchString){return this.updateSearchCollection(searchString)});return this.searchCollection=this.liveCollection.createLiveChildCollection().setFilter("search",function(model,searchString){var pass,searchRegex;if((searchString==null)||(searchString!=null?searchString.length:void 0)<3){return true}searchRegex=queryEngine.createSafeRegex(searchString);pass=searchRegex.test(model.get("title"));return pass}).query()};EntryFields.prototype.updateSearchCollection=function(searchString){return this.searchCollection.setSearchString(searchString).query()};return EntryFields})(Entities.Collection);API={getEntryFieldEntities:function(options){var fields;fields=new Entities.EntryFields([],_.omit(options,"callback"));fields.fetch({reset:true});return fields}};return App.reqres.setHandler("entry:fields:entities",function(options){if(options==null){options={}}return API.getEntryFieldEntities(options)})})}).call(this);