(function(){var root=this;var _,Backbone,BackboneModel,BackboneCollection,ModelProto,CollectionProto,defaultEvents,AssociatedModel,pathChecker,collectionEvents;if(typeof window==="undefined"){_=require("underscore");Backbone=require("backbone");if(typeof exports!=="undefined"){exports=module.exports=Backbone}}else{_=root._;Backbone=root.Backbone}BackboneModel=Backbone.Model;BackboneCollection=Backbone.Collection;ModelProto=BackboneModel.prototype;CollectionProto=BackboneCollection.prototype;pathChecker=/[\.\[\]]+/g;defaultEvents=["change","add","remove","reset","sort","destroy"];collectionEvents=["reset","sort"];Backbone.Associations={VERSION:"0.5.2"};Backbone.Associations.Many=Backbone.Many="Many";Backbone.Associations.One=Backbone.One="One";Backbone.Associations.Self=Backbone.Self="Self";AssociatedModel=Backbone.AssociatedModel=Backbone.Associations.AssociatedModel=BackboneModel.extend({relations:undefined,_proxyCalls:undefined,get:function(attr){var obj=ModelProto.get.call(this,attr);return obj?obj:this._getAttr.apply(this,arguments)},set:function(key,value,options){var attributes,result;if(_.isObject(key)||key==null){attributes=key;options=value}else{attributes={};attributes[key]=value}result=this._set(attributes,options);this._processPendingEvents();return result},_set:function(attributes,options){var attr,modelMap,modelId,obj,result=this;if(!attributes){return this}for(attr in attributes){modelMap||(modelMap={});if(attr.match(pathChecker)){var pathTokens=getPathArray(attr),initials=_.initial(pathTokens),last=pathTokens[pathTokens.length-1],parentModel=this.get(initials);if(parentModel instanceof AssociatedModel){obj=modelMap[parentModel.cid]||(modelMap[parentModel.cid]={model:parentModel,data:{}});obj.data[last]=attributes[attr]}}else{obj=modelMap[this.cid]||(modelMap[this.cid]={model:this,data:{}});obj.data[attr]=attributes[attr]}}if(modelMap){for(modelId in modelMap){obj=modelMap[modelId];this._setAttr.call(obj.model,obj.data,options)||(result=false)}}else{result=this._setAttr.call(this,attributes,options)}return result},_setAttr:function(attributes,options){var attr;options||(options={});if(options.unset){for(attr in attributes){attributes[attr]=void 0}}this.parents=this.parents||[];if(this.relations){_.each(this.relations,function(relation){var relationKey=relation.key,relatedModel=relation.relatedModel,collectionType=relation.collectionType,map=relation.map,currVal=this.attributes[relationKey],idKey=currVal&&currVal.idAttribute,val,relationOptions,data,relationValue,newCtx=false;if(relatedModel&&!(relatedModel.prototype instanceof BackboneModel)){relatedModel=_.isFunction(relatedModel)?relatedModel.call(this,relation,attributes):relatedModel}if(relatedModel&&_.isString(relatedModel)){relatedModel=(relatedModel===Backbone.Self)?this.constructor:map2Scope(relatedModel)}collectionType&&_.isString(collectionType)&&(collectionType=map2Scope(collectionType));map&&_.isString(map)&&(map=map2Scope(map));relationOptions=relation.options?_.extend({},relation.options,options):options;if((!relatedModel)&&(!collectionType)){throw new Error("specify either a relatedModel or collectionType")}if(attributes[relationKey]){val=_.result(attributes,relationKey);val=map?map.call(this,val,collectionType?collectionType:relatedModel):val;if(relation.type===Backbone.Many){if(collectionType&&!collectionType.prototype instanceof BackboneCollection){throw new Error("collectionType must inherit from Backbone.Collection")}if(val instanceof BackboneCollection&&!currVal){data=val;newCtx=true}else{if(!currVal){data=collectionType?new collectionType():this._createCollection(relatedModel)}else{data=currVal;data._deferEvents=true}data[relationOptions.reset?"reset":"set"](val instanceof BackboneCollection?val.models:val,relationOptions)}}else{if(relation.type===Backbone.One){if(!relatedModel){throw new Error("specify a relatedModel for Backbone.One type")}if(!(relatedModel.prototype instanceof Backbone.AssociatedModel)){throw new Error("specify an AssociatedModel for Backbone.One type")}if(val instanceof AssociatedModel){data=val;newCtx=(currVal!==val)}else{if(!currVal){data=new relatedModel(val,relationOptions)}else{if(currVal&&val[idKey]&&currVal.get(idKey)===val[idKey]){currVal._deferEvents=true;currVal._set(val,relationOptions);data=currVal}else{data=new relatedModel(val,relationOptions)}}}}else{throw new Error("type attribute must be specified and have the values Backbone.One or Backbone.Many")}}attributes[relationKey]=data;relationValue=data;if(newCtx||(relationValue&&!relationValue._proxyCallback)){relationValue._proxyCallback=function(){return this._bubbleEvent.call(this,relationKey,relationValue,arguments)};relationValue.on("all",relationValue._proxyCallback,this)}}if(attributes.hasOwnProperty(relationKey)){var updated=attributes[relationKey];var original=this.attributes[relationKey];if(updated){updated.parents=updated.parents||[];(_.indexOf(updated.parents,this)==-1)&&updated.parents.push(this)}else{if(original&&original.parents.length>0){original.parents=_.difference(original.parents,[this]);original._proxyCallback&&original.off("all",original._proxyCallback,this)}}}},this)}return ModelProto.set.call(this,attributes,options)},_bubbleEvent:function(relationKey,relationValue,eventArguments){var args=eventArguments,opt=args[0].split(":"),eventType=opt[0],catch_all=args[0]=="nested-change",eventObject=args[1],colObject=args[2],indexEventObject=-1,_proxyCalls=relationValue._proxyCalls,cargs,eventPath,basecolEventPath,isDefaultEvent=_.indexOf(defaultEvents,eventType)!==-1;if(catch_all){return}_.size(opt)>1&&(eventPath=opt[1]);if(_.indexOf(collectionEvents,eventType)!==-1){colObject=eventObject}if(relationValue instanceof BackboneCollection&&isDefaultEvent&&eventObject){var pathTokens=getPathArray(eventPath),initialTokens=_.initial(pathTokens),colModel;colModel=relationValue.find(function(model){if(eventObject===model){return true}if(!model){return false}var changedModel=model.get(initialTokens);if((changedModel instanceof AssociatedModel||changedModel instanceof BackboneCollection)&&eventObject===changedModel){return true}changedModel=model.get(pathTokens);if((changedModel instanceof AssociatedModel||changedModel instanceof BackboneCollection)&&eventObject===changedModel){return true}if(changedModel instanceof BackboneCollection&&colObject&&colObject===changedModel){return true}});colModel&&(indexEventObject=relationValue.indexOf(colModel))}eventPath=relationKey+((indexEventObject!==-1&&(eventType==="change"||eventPath))?"["+indexEventObject+"]":"")+(eventPath?"."+eventPath:"");if(/\[\*\]/g.test(eventPath)){return this}basecolEventPath=eventPath.replace(/\[\d+\]/g,"[*]");cargs=[];cargs.push.apply(cargs,args);cargs[0]=eventType+":"+eventPath;_proxyCalls=relationValue._proxyCalls=(_proxyCalls||{});if(this._isEventAvailable.call(this,_proxyCalls,eventPath)){return this}_proxyCalls[eventPath]=true;if("change"===eventType){this._previousAttributes[relationKey]=relationValue._previousAttributes;this.changed[relationKey]=relationValue}this.trigger.apply(this,cargs);if("change"===eventType&&this.get(eventPath)!=args[2]){var ncargs=["nested-change",eventPath,args[1]];args[2]&&ncargs.push(args[2]);this.trigger.apply(this,ncargs)}if(_proxyCalls&&eventPath){delete _proxyCalls[eventPath]}if(eventPath!==basecolEventPath){cargs[0]=eventType+":"+basecolEventPath;this.trigger.apply(this,cargs)}return this},_isEventAvailable:function(_proxyCalls,path){return _.find(_proxyCalls,function(value,eventKey){return path.indexOf(eventKey,path.length-eventKey.length)!==-1})},_createCollection:function(type){var collection,relatedModel=type;_.isString(relatedModel)&&(relatedModel=map2Scope(relatedModel));if(relatedModel&&relatedModel.prototype instanceof AssociatedModel){collection=new BackboneCollection();collection.model=relatedModel}else{throw new Error("type must inherit from Backbone.AssociatedModel")}return collection},_processPendingEvents:function(){if(!this._processedEvents){this._processedEvents=true;this._deferEvents=false;_.each(this._pendingEvents,function(e){e.c.trigger.apply(e.c,e.a)});this._pendingEvents=[];_.each(this.relations,function(relation){var val=this.attributes[relation.key];val&&val._processPendingEvents()},this);delete this._processedEvents}},trigger:function(name){if(this._deferEvents){this._pendingEvents=this._pendingEvents||[];this._pendingEvents.push({c:this,a:arguments})}else{ModelProto.trigger.apply(this,arguments)}},toJSON:function(options){var json={},aJson;json[this.idAttribute]=this.id;if(!this.visited){this.visited=true;json=ModelProto.toJSON.apply(this,arguments);if(this.relations){_.each(this.relations,function(relation){var attr=this.attributes[relation.key];if(attr){aJson=attr.toJSON(options);json[relation.key]=_.isArray(aJson)?_.compact(aJson):aJson}},this)}delete this.visited}return json},clone:function(){return new this.constructor(this.toJSON())},cleanup:function(){_.each(this.relations,function(relation){var val=this.attributes[relation.key];val&&(val.parents=_.difference(val.parents,[this]))},this);this.off()},_getAttr:function(path){var result=this,attrs=getPathArray(path),key,i;if(_.size(attrs)<1){return}for(i=0;i<attrs.length;i++){key=attrs[i];if(!result){break}result=result instanceof BackboneCollection?(isNaN(key)?undefined:result.at(key)):result.attributes[key]}return result}});var delimiters=/[^\.\[\]]+/g;var getPathArray=function(path){if(path===""){return[""]}return _.isString(path)?(path.match(delimiters)):path||[]};var map2Scope=function(path){return _.reduce(path.split("."),function(memo,elem){return memo[elem]},root)};var map2models=function(parents,target,models){var relation,surrogate;_.find(parents,function(parent){relation=_.find(parent.relations,function(rel){return parent.get(rel.key)===target},this);if(relation){surrogate=parent;return true}},this);if(relation&&relation.map){return relation.map.call(surrogate,models,target)}return models};var proxies={};_.each(["set","remove","reset"],function(method){proxies[method]=BackboneCollection.prototype[method];CollectionProto[method]=function(models,options){if(this.model.prototype instanceof AssociatedModel&&this.parents){arguments[0]=map2models(this.parents,this,models)}return proxies[method].apply(this,arguments)}});proxies.trigger=CollectionProto.trigger;CollectionProto.trigger=function(name){if(this._deferEvents){this._pendingEvents=this._pendingEvents||[];this._pendingEvents.push({c:this,a:arguments})}else{proxies.trigger.apply(this,arguments)}};CollectionProto._processPendingEvents=AssociatedModel.prototype._processPendingEvents}).call(this);